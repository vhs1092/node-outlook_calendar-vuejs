{"version":3,"sources":["webpack:///server.js","webpack:///webpack/bootstrap fd9cd82cc1c23683b04a","webpack:///external \"babel-runtime/core-js/object/assign\"","webpack:///external \"babel-runtime/core-js/object/keys\"","webpack:///external \"fs\"","webpack:///external \"lodash\"","webpack:///./server/utils.js","webpack:///external \"babel-runtime/core-js/get-iterator\"","webpack:///external \"babel-runtime/helpers/typeof\"","webpack:///./server/command-manager.js","webpack:///external \"babel-runtime/core-js/promise\"","webpack:///external \"babel-runtime/core-js/json/stringify\"","webpack:///./server/app.js","webpack:///external \"os\"","webpack:///external \"path\"","webpack:///external \"events\"","webpack:///external \"child_process\"","webpack:///external \"keypair\"","webpack:///./lib/cycle.js","webpack:///./server/bunyan-stream.js","webpack:///./lib/common-utils.js","webpack:///external \"source-map-support\"","webpack:///./server/setup-server.js","webpack:///external \"restify\"","webpack:///./server/setup-socket.js","webpack:///external \"socket.io\"","webpack:///external \"minimist\"","webpack:///./server/ssh-manager.js","webpack:///external \"tty\"","webpack:///external \"pty.js\"","webpack:///external \"ssh2\"","webpack:///external \"terminal-kit\"","webpack:///./server/user-manager.js","webpack:///external \"scrypt\""],"names":["require","install","module","exports","modules","__webpack_require__","moduleId","installedModules","i","l","call","m","c","d","name","getter","o","Object","defineProperty","configurable","enumerable","get","n","__esModule","object","property","prototype","hasOwnProperty","p","s","_interopRequireDefault","obj","default","value","_assign","_assign2","_commonUtils","_commonUtils2","_sourceMapSupport","_sourceMapSupport2","parseCommand","str","reg","arr","match","exec","push","getStack","prep","Error","prepareStackTrace","limit","stackTraceLimit","error","trace","map","wrapCallSite","stack","slice","CommandManager","this","commands","_promise","_promise2","_lodash","_lodash2","_utils","_utils2","_minimist","_minimist2","addCmd","cmdName","opts","bindI","ioInterface","_this","boundI","mapValues","constructor","val","key","Function","bind","runCmd","io","rawCommand","asUser","_this2","resolve","reject","parsed","cmd","args","username","write","writeLn","prompt","NodeMonkey","warnConsole","warned","warningMsg","join","self","local","warn","remote","NODE_ENV","process","options","merge","server","host","port","DEFAULT_PORT","silent","bufferSize","attachOnStart","disableLocalOutput","client","showCallerInfo","convertStyles","ssh","enabled","title","_os2","hostname","dataDir","msgBuffer","BUNYAN_STREAM","_bunyanStream2","_attached","_typeHandlers","_createLocal","_createRemote","_setupCmdMan","_setupUserManager","_setupServer","_setupSSH","attachConsole","console","fn","method","localFn","apply","arguments","remoteFn","callerStackDistance","_getIterator2","_getIterator3","_keys","_keys2","_os","_fs","_fs2","_path","_path2","_events","_events2","_keypair","_keypair2","_cycle","_cycle2","_bunyanStream","_setupServer2","_setupServer3","_setupSocket","_setupSocket2","_sshManager","_sshManager2","_commandManager","_commandManager2","_userManager","_userManager2","CONSOLE","ConsoleEvent","HANDLE_TYPES","attachedCount","assign","_getServerProtocol","tlsClientError","getServerPaths","basePath","normalize","__dirname","index","_displayServerWelcome","listening","proto","_server$address","address","log","on","_cmdMan","cmdMan","promptTxt","cb","undefined","userMan","userManager","userFile","term","done","getUsers","then","users","_","hideInput","password","passwordAgain","createUser","catch","deleteUser","user","curpwd","verifyUser","matches","setPassword","serverApp","_options$server","listen","remoteClients","cmdManager","onAuth","_sendMessages","clientSettings","sshOpts","files","readdirSync","keyRe","hostKeys","_iteratorNormalCompletion","_didIteratorError","_iteratorError","_step","_iterator","next","file","test","err","return","length","keys","writeFileSync","private","public","SSHMan","monkey","result","_getCallerInfo","frame","functionName","getFunctionName","methodName","getMethodName","fileName","getFileName","lineNumber","getLineNumber","columnNumber","getColumnNumber","caller","find","twoBack","sixBack","line","column","_sendMessage","info","callerInfo","shift","size","adapter","rooms","each","to","emit","decycle","forEach","Array","handlersActive","concat","serverOptions","handler","detachConsole","removeListener","instances","lastPort","set","_typeof2","_typeof3","origJSON","global","JSON","replacer","objects","paths","derez","path","nu","Boolean","Date","Number","RegExp","String","indexOf","$ref","isArray","element","stringify","retrocycle","$","px","rez","eval","item","levelFromName","debug","fatal","nameFromLevel","invert","inst","rec","parse","level","msg","isObject","type","inverted","k","_restify","_restify2","createServer","pre","userAgentConnection","use","gzipResponse","CORS","credentials","serveStatic","directory","createCmdMan","socket","promptId","prompts","cmdManOpts","pid","response","_socket","_socket2","ns","attach","of","creds","cmdId","command","output","message","handlers","event","SSHManager","clients","clientId","_ssh2","Server","readFileSync","onClient","SSHClient","session","stream","pty","ptyInfo","inputActive","cmdHistory","onReady","onClose","_stringify","_stringify2","_tty","_tty2","_pty","_pty2","_ssh","_terminalKit","_terminalKit2","shutdown","close","_initCmdMan","bold","newline","nextLine","red","inputOpts","echo","inputField","style","end","ctx","_this3","accept","_this4","once","_resize","_initStream","_initPty","_initTerm","onKey","data","_this5","clearScreen","abort","input","getInput","setTimeout","stdout","isTTY","setRawMode","_this6","newPty","native","open","cols","rows","master_fd","master","slave_fd","slave","WriteStream","ReadStream","getWindowSize","stdin","pipe","createTerminal","stderr","generic","appName","windowTitle","_interpolate","varRe","vars","replace","clear","_this7","history","autoComplete","autoCompleteMenu","stringToBuffer","string","base","useNew","Buffer","from","UserManager","userFileCache","userFileCreated","usernames","env","_scrypt","_scrypt2","_readFile","code","guest","_writeFile","_hashPassword","passwd","kdfSync","N","r","toString","_verifyPassword","hash","verifyKdfSync","getUserData","userData"],"mappings":"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","file":"server.js","sourcesContent":["require(\"source-map-support\").install();\nmodule.exports = \n/******/ (function(modules) { // webpackBootstrap\n/******/ \t// The module cache\n/******/ \tvar installedModules = {};\n/******/\n/******/ \t// The require function\n/******/ \tfunction __webpack_require__(moduleId) {\n/******/\n/******/ \t\t// Check if module is in cache\n/******/ \t\tif(installedModules[moduleId]) {\n/******/ \t\t\treturn installedModules[moduleId].exports;\n/******/ \t\t}\n/******/ \t\t// Create a new module (and put it into the cache)\n/******/ \t\tvar module = installedModules[moduleId] = {\n/******/ \t\t\ti: moduleId,\n/******/ \t\t\tl: false,\n/******/ \t\t\texports: {}\n/******/ \t\t};\n/******/\n/******/ \t\t// Execute the module function\n/******/ \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n/******/\n/******/ \t\t// Flag the module as loaded\n/******/ \t\tmodule.l = true;\n/******/\n/******/ \t\t// Return the exports of the module\n/******/ \t\treturn module.exports;\n/******/ \t}\n/******/\n/******/\n/******/ \t// expose the modules object (__webpack_modules__)\n/******/ \t__webpack_require__.m = modules;\n/******/\n/******/ \t// expose the module cache\n/******/ \t__webpack_require__.c = installedModules;\n/******/\n/******/ \t// define getter function for harmony exports\n/******/ \t__webpack_require__.d = function(exports, name, getter) {\n/******/ \t\tif(!__webpack_require__.o(exports, name)) {\n/******/ \t\t\tObject.defineProperty(exports, name, {\n/******/ \t\t\t\tconfigurable: false,\n/******/ \t\t\t\tenumerable: true,\n/******/ \t\t\t\tget: getter\n/******/ \t\t\t});\n/******/ \t\t}\n/******/ \t};\n/******/\n/******/ \t// getDefaultExport function for compatibility with non-harmony modules\n/******/ \t__webpack_require__.n = function(module) {\n/******/ \t\tvar getter = module && module.__esModule ?\n/******/ \t\t\tfunction getDefault() { return module['default']; } :\n/******/ \t\t\tfunction getModuleExports() { return module; };\n/******/ \t\t__webpack_require__.d(getter, 'a', getter);\n/******/ \t\treturn getter;\n/******/ \t};\n/******/\n/******/ \t// Object.prototype.hasOwnProperty.call\n/******/ \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n/******/\n/******/ \t// __webpack_public_path__\n/******/ \t__webpack_require__.p = \"\";\n/******/\n/******/ \t// Load entry module and return exports\n/******/ \treturn __webpack_require__(__webpack_require__.s = 10);\n/******/ })\n/************************************************************************/\n/******/ ([\n/* 0 */\n/***/ (function(module, exports) {\n\nmodule.exports = require(\"babel-runtime/core-js/object/assign\");\n\n/***/ }),\n/* 1 */\n/***/ (function(module, exports) {\n\nmodule.exports = require(\"babel-runtime/core-js/object/keys\");\n\n/***/ }),\n/* 2 */\n/***/ (function(module, exports) {\n\nmodule.exports = require(\"fs\");\n\n/***/ }),\n/* 3 */\n/***/ (function(module, exports) {\n\nmodule.exports = require(\"lodash\");\n\n/***/ }),\n/* 4 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\nObject.defineProperty(exports,\"__esModule\",{value:true});var _assign=__webpack_require__(0);var _assign2=_interopRequireDefault(_assign);var _commonUtils=__webpack_require__(18);var _commonUtils2=_interopRequireDefault(_commonUtils);var _sourceMapSupport=__webpack_require__(19);var _sourceMapSupport2=_interopRequireDefault(_sourceMapSupport);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}exports.default=(0,_assign2.default)({parseCommand:function parseCommand(str){var reg=/\"(.*?)\"|'(.*?)'|`(.*?)`|([^\\s\"]+)/gi;var arr=[],match=void 0;do{match=reg.exec(str);if(match!==null){arr.push(match[1]||match[2]||match[3]||match[4]);}}while(match!==null);return arr;},getStack:function getStack(){var prep=Error.prepareStackTrace;var limit=Error.stackTraceLimit;Error.prepareStackTrace=function(error,trace){return trace.map(_sourceMapSupport2.default.wrapCallSite);};Error.stackTraceLimit=30;var stack=new Error().stack;Error.prepareStackTrace=prep;Error.stackTraceLimit=limit;return stack.slice(1);}},_commonUtils2.default);\n\n/***/ }),\n/* 5 */\n/***/ (function(module, exports) {\n\nmodule.exports = require(\"babel-runtime/core-js/get-iterator\");\n\n/***/ }),\n/* 6 */\n/***/ (function(module, exports) {\n\nmodule.exports = require(\"babel-runtime/helpers/typeof\");\n\n/***/ }),\n/* 7 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\nObject.defineProperty(exports,\"__esModule\",{value:true});var _promise=__webpack_require__(8);var _promise2=_interopRequireDefault(_promise);var _assign=__webpack_require__(0);var _assign2=_interopRequireDefault(_assign);var _lodash=__webpack_require__(3);var _lodash2=_interopRequireDefault(_lodash);var _utils=__webpack_require__(4);var _utils2=_interopRequireDefault(_utils);var _minimist=__webpack_require__(24);var _minimist2=_interopRequireDefault(_minimist);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function CommandManager(){this.commands={};}(0,_assign2.default)(CommandManager.prototype,{addCmd:function addCmd(cmdName,opts,exec){if(this.commands[cmdName]){throw new Error('\\''+cmdName+'\\' is already registered as a command');}if(typeof opts==='function'){exec=opts;opts={};}this.commands[cmdName]={opts:opts,exec:exec};},bindI:function bindI(ioInterface){var _this=this;var boundI=_lodash2.default.mapValues(this);(0,_assign2.default)(boundI,_lodash2.default.mapValues(this.constructor.prototype,function(val,key){if(val instanceof Function){if(key==='runCmd'){return val.bind(_this,ioInterface);}return val.bind(_this);}else{return val;}}));return boundI;},runCmd:function runCmd(io,rawCommand,asUser){var _this2=this;return new _promise2.default(function(resolve,reject){var parsed=_utils2.default.parseCommand(rawCommand),cmdName=parsed[0],cmd=_this2.commands[cmdName];if(!asUser){return reject('Missing user context for command \\''+cmdName+'\\'');}if(!cmd){return reject('Command not found: \\''+cmdName+'\\'');}var args=(0,_minimist2.default)(parsed.slice(1));cmd.exec({args:args,username:asUser},{write:io.write,writeLn:io.writeLn,error:io.error,prompt:io.prompt},resolve);});}});exports.default=CommandManager;\n\n/***/ }),\n/* 8 */\n/***/ (function(module, exports) {\n\nmodule.exports = require(\"babel-runtime/core-js/promise\");\n\n/***/ }),\n/* 9 */\n/***/ (function(module, exports) {\n\nmodule.exports = require(\"babel-runtime/core-js/json/stringify\");\n\n/***/ }),\n/* 10 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\nvar _assign=__webpack_require__(0);var _assign2=_interopRequireDefault(_assign);var _getIterator2=__webpack_require__(5);var _getIterator3=_interopRequireDefault(_getIterator2);var _keys=__webpack_require__(1);var _keys2=_interopRequireDefault(_keys);var _os=__webpack_require__(11);var _os2=_interopRequireDefault(_os);var _fs=__webpack_require__(2);var _fs2=_interopRequireDefault(_fs);var _path=__webpack_require__(12);var _path2=_interopRequireDefault(_path);var _events=__webpack_require__(13);var _events2=_interopRequireDefault(_events);var _child_process=__webpack_require__(14);var _lodash=__webpack_require__(3);var _lodash2=_interopRequireDefault(_lodash);var _keypair=__webpack_require__(15);var _keypair2=_interopRequireDefault(_keypair);var _cycle=__webpack_require__(16);var _cycle2=_interopRequireDefault(_cycle);var _bunyanStream=__webpack_require__(17);var _bunyanStream2=_interopRequireDefault(_bunyanStream);var _setupServer2=__webpack_require__(20);var _setupServer3=_interopRequireDefault(_setupServer2);var _setupSocket=__webpack_require__(22);var _setupSocket2=_interopRequireDefault(_setupSocket);var _sshManager=__webpack_require__(25);var _sshManager2=_interopRequireDefault(_sshManager);var _commandManager=__webpack_require__(7);var _commandManager2=_interopRequireDefault(_commandManager);var _userManager=__webpack_require__(30);var _userManager2=_interopRequireDefault(_userManager);var _utils=__webpack_require__(4);var _utils2=_interopRequireDefault(_utils);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var DEFAULT_PORT=50500;var CONSOLE=_lodash2.default.mapValues(console);var ConsoleEvent=new _events2.default();var HANDLE_TYPES=['log','info','warn','error','dir'];var attachedCount=0;function NodeMonkey(opts){var NODE_ENV=process.NODE_ENV;var options=this.options=_lodash2.default.merge({server:{// You can provide your own server and Node Monkey will use it instead of creating its own.\n// However, this MUST be the underlying http server instance, not the express/restify/whatever app.\nserver:null,host:'0.0.0.0',port:DEFAULT_PORT,silent:false,bufferSize:50,attachOnStart:true,// Only takes effect when Node Monkey is attached to the console\ndisableLocalOutput:false},client:{showCallerInfo:NODE_ENV==='production'?false:true,convertStyles:true},ssh:{enabled:false,host:'0.0.0.0',port:DEFAULT_PORT+1,title:'Node Monkey on '+_os2.default.hostname(),prompt:'[Node Monkey] {@username}@'+_os2.default.hostname()+':'},// Needed for storing things like user files and SSH host keys\ndataDir:null},opts);this.msgBuffer=[];this.BUNYAN_STREAM=(0,_bunyanStream2.default)(this);this._attached=false;this._typeHandlers={};this._createLocal();this._createRemote();this._setupCmdMan();this._setupUserManager();this._setupServer();this._setupSSH();if(options.server.attachOnStart){this.attachConsole();}// TODO: Deprecated. Remove everything after this line by v1.0.0\nvar self=this;var warned=false;function warnConsole(){if(!warned){warned=true;var warningMsg=['[Deprecation Warning] Running Node Monkey with \\'augmentConsole\\' enabled.','This is strongly discouraged and will be removed in the v1.0.0 release.','See here for more info: https://github.com/jwarkentin/node-monkey/releases/tag/v1.0.0-rc.1'].join(' ');self.local.warn(warningMsg);self.remote.warn(warningMsg);}}// This is here because webpack renames the function and for whatever reason the stack trace doesn't show the right name,\n// even with proper source maps. This is all just temporary anyway so I'm hacking it.\nObject.defineProperty(warnConsole,'name',{value:'warnConsole'});console.local=_lodash2.default.mapValues(this.local,function(fn,method){var localFn=function localFn(){warnConsole();return fn.apply(console,arguments);};Object.defineProperty(localFn,'name',{value:method});return localFn;});console.remote=_lodash2.default.mapValues(this.remote,function(fn,method){var remoteFn=function remoteFn(){warnConsole();return fn.apply({callerStackDistance:2},arguments);};Object.defineProperty(remoteFn,'name',{value:method});return remoteFn;});}_lodash2.default.assign(NodeMonkey.prototype,{_getServerProtocol:function _getServerProtocol(server){if(server._events&&server._events.tlsClientError){return'https';}return'http';},getServerPaths:function getServerPaths(){var basePath=_path2.default.normalize(__dirname+'/../dist');return{basePath:basePath,client:'monkey.js',index:'index.html'};},_displayServerWelcome:function _displayServerWelcome(){if(!this.options.server.silent){var server=this.options.server.server;if(server.listening){var proto=this._getServerProtocol(server);var _server$address=server.address(),address=_server$address.address,port=_server$address.port;this.local.log('Node Monkey listening at '+proto+'://'+address+':'+port);}else{server.on('listening',this._displayServerWelcome.bind(this));}}},_setupCmdMan:function _setupCmdMan(){this._cmdMan=new _commandManager2.default();var cmdMan=this.cmdMan=this._cmdMan.bindI({write:function write(val,opts){console.log(val);},writeLn:function writeLn(val,opts){console.log(val);},error:function error(val,opts){console.error(val);},prompt:function prompt(promptTxt,opts,cb){if(typeof opts==='function'){cb=opts;opts=undefined;}opts||(opts={});console.warn('Prompt not implemented');}});this.addCmd=cmdMan.addCmd;this.runCmd=cmdMan.runCmd;},_setupUserManager:function _setupUserManager(){var dataDir=this.options.dataDir;var userMan=this.userManager=new _userManager2.default({userFile:dataDir?dataDir+'/users.json':undefined,silent:this.options.server.silent});this.cmdMan.addCmd('showusers',function(opts,term,done){var users=userMan.getUsers().then(function(users){term.writeLn((0,_keys2.default)(users).join('\\n'));done();});});this.cmdMan.addCmd('adduser',function(opts,term,done){var args=opts.args,username=args._[0];if(!username){term.error('You must specify a username');return done();}term.prompt('Password: ',{hideInput:true},function(error,password){term.writeLn();term.prompt('Again: ',{hideInput:true},function(error,passwordAgain){term.writeLn();if(password===passwordAgain){userMan.createUser(username,password).then(function(){return term.write('Created user \\''+username+'\\'');}).catch(term.error).then(done);}else{term.error('Passwords do not match');done();}});});});this.cmdMan.addCmd('deluser',function(opts,term,done){var args=opts.args,username=args._[0];if(!username){term.error('You must specify a username');return done();}userMan.deleteUser(username).then(function(){return term.write('Deleted user \\''+username+'\\'');}).catch(term.error).then(done);});this.cmdMan.addCmd('passwd',function(opts,term,done){var args=opts.args,user=opts.username;term.prompt('Current password: ',{hideInput:true},function(error,curpwd){term.writeLn();userMan.verifyUser(user,curpwd).then(function(matches){if(matches){term.prompt('Password: ',{hideInput:true},function(error,password){term.writeLn();term.prompt('Again: ',{hideInput:true},function(error,passwordAgain){term.writeLn();if(password===passwordAgain){userMan.setPassword(user,password).then(function(){return term.write('Updated password for '+user);}).catch(term.error).then(done);}else{term.error('Passwords do not match');done();}});});}else{term.error('Incorrect password');done();}});});});},_setupServer:function _setupServer(){var options=this.options,server=options.server.server;if(!server){var serverApp=(0,_setupServer3.default)({name:'Node Monkey'});server=this.options.server.server=serverApp.server;var _options$server=options.server,host=_options$server.host,port=_options$server.port;serverApp.listen(port,host);}this._displayServerWelcome();this.serverApp=server;this.remoteClients=(0,_setupSocket2.default)({server:server.server||server,cmdManager:this._cmdMan,userManager:this.userManager,onAuth:this._sendMessages.bind(this),clientSettings:options.client});},_setupSSH:function _setupSSH(){var sshOpts=this.options.ssh;if(sshOpts.enabled){var dataDir=this.options.dataDir;if(!dataDir){throw new Error('Options \\'dataDir\\' is required to enable SSH');}// Get host keys\nvar files=_fs2.default.readdirSync(dataDir),keyRe=/\\.key$/,hostKeys=[];var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=(0,_getIterator3.default)(files),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var file=_step.value;if(keyRe.test(file)){hostKeys.push(dataDir+'/'+file);}}}catch(err){_didIteratorError=true;_iteratorError=err;}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally{if(_didIteratorError){throw _iteratorError;}}}if(!hostKeys.length){console.log('No SSH host key found. Generating new host key...');var keys=(0,_keypair2.default)();_fs2.default.writeFileSync(dataDir+'/rsa.key',keys.private);_fs2.default.writeFileSync(dataDir+'/rsa.key.pub',keys.public);hostKeys=[dataDir+'/rsa.key'];}this.SSHMan=new _sshManager2.default({monkey:this,cmdManager:this._cmdMan,userManager:this.userManager,silent:this.options.server.silent,host:sshOpts.host,port:sshOpts.port,title:_lodash2.default.result(sshOpts,'title'),prompt:_lodash2.default.result(sshOpts,'prompt'),hostKeys:hostKeys});}},// TODO: This whole process of trying to identify the true source of the call is so fucking messy and fragile. Need to think\n//       of a better way to identify the call source and rewrite all this shitty code handling it right now.\n_getCallerInfo:function _getCallerInfo(callerStackDistance){if(this.options.client.showCallerInfo){var stack=_utils2.default.getStack().map(function(frame){return{functionName:frame.getFunctionName(),methodName:frame.getMethodName(),fileName:frame.getFileName(),lineNumber:frame.getLineNumber(),columnNumber:frame.getColumnNumber()};});var caller=stack.find(function(frame,index,stack){// We're either looking for a console method call or a bunyan log call. This logic will break down if method names change.\nvar twoBack=stack[index-2];var sixBack=stack[index-4];if(twoBack&&twoBack.functionName==='Logger._emit'&&/\\/bunyan\\.js$/.test(twoBack.fileName)){return true;}else if(twoBack&&sixBack&&twoBack.methodName==='emit'&&sixBack.methodName==='_sendMessage'){return true;}});if(!caller&&typeof callerStackDistance==='number'){caller=stack[callerStackDistance];}if(caller){return{caller:caller.functionName||caller.methodName,file:caller.fileName,line:caller.lineNumber,column:caller.columnNumber};}}},_sendMessage:function _sendMessage(info,callerStackDistance){this.msgBuffer.push({method:info.method,args:info.args,callerInfo:info.callerInfo||this._getCallerInfo(callerStackDistance+1)});if(this.msgBuffer.length>this.options.server.bufferSize){this.msgBuffer.shift();}this._sendMessages();},_sendMessages:function _sendMessages(){var remoteClients=this.remoteClients;if(_lodash2.default.size(remoteClients.adapter.rooms['authed'])){_lodash2.default.each(this.msgBuffer,function(info){remoteClients.to('authed').emit('console',_cycle2.default.decycle(info));});this.msgBuffer=[];}},_createLocal:function _createLocal(){// NOTE: The console functions here should not be wrapped since these values are used to restore the defaults\n//       when `detachConsole()` is called.\nthis.local=CONSOLE;},_createRemote:function _createRemote(){var self=this;var remote=this.remote={};HANDLE_TYPES.forEach(function(method){self.remote[method]=function(){self._sendMessage({method:method,args:Array.prototype.slice.call(arguments)},this.callerStackDistance?this.callerStackDistance+1:2);};Object.defineProperty(remote[method],'name',{value:method});});},attachConsole:function attachConsole(disableLocalOutput){var _this=this;if(this._attached){return;}if(!attachedCount){// If this function is in the process of handling the log call we will try and prevent potential infinite recursion\nvar handlersActive=0;HANDLE_TYPES.forEach(function(method){console[method]=function(){if(handlersActive){return self.local[method].apply(console,arguments);}++handlersActive;ConsoleEvent.emit.apply(ConsoleEvent,[method].concat(Array.prototype.slice.call(arguments)));--handlersActive;};Object.defineProperty(console[method],'name',{value:method});});}++attachedCount;var self=this;var serverOptions=this.options.server;disableLocalOutput=disableLocalOutput!==undefined?disableLocalOutput:serverOptions.disableLocalOutput;_lodash2.default.each(this.remote,function(fn,method){var handler=_this._typeHandlers[method]=function(){fn.apply({callerStackDistance:5},arguments);if(!disableLocalOutput){self.local[method].apply(console,arguments);}};Object.defineProperty(handler,'name',{value:method});ConsoleEvent.on(method,handler);});this._attached=true;},detachConsole:function detachConsole(){var _this2=this;(0,_assign2.default)(console,this.local);this._attached=false;--attachedCount;HANDLE_TYPES.forEach(function(method){ConsoleEvent.removeListener(method,_this2._typeHandlers[method]);delete _this2._typeHandlers[method];});}});var instances={};var lastPort=DEFAULT_PORT-1;module.exports=function createInst(options){var name=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'default';if(typeof options==='string'){name=options;options=undefined;}if(!instances[name]){options||(options={});var port=_lodash2.default.get(options,'server.port');if(port){lastPort=+port;}else{_lodash2.default.set(options,'server.port',++lastPort);_lodash2.default.set(options,'ssh.port',++lastPort);}instances[name]=new NodeMonkey(options);}return instances[name];};// Just exporting in case someone needs to wrap this or access the internals for some reason\nmodule.exports.NodeMonkey=NodeMonkey;\n\n/***/ }),\n/* 11 */\n/***/ (function(module, exports) {\n\nmodule.exports = require(\"os\");\n\n/***/ }),\n/* 12 */\n/***/ (function(module, exports) {\n\nmodule.exports = require(\"path\");\n\n/***/ }),\n/* 13 */\n/***/ (function(module, exports) {\n\nmodule.exports = require(\"events\");\n\n/***/ }),\n/* 14 */\n/***/ (function(module, exports) {\n\nmodule.exports = require(\"child_process\");\n\n/***/ }),\n/* 15 */\n/***/ (function(module, exports) {\n\nmodule.exports = require(\"keypair\");\n\n/***/ }),\n/* 16 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\nvar _keys=__webpack_require__(1);var _keys2=_interopRequireDefault(_keys);var _typeof2=__webpack_require__(6);var _typeof3=_interopRequireDefault(_typeof2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}/*\n    cycle.js\n    2016-05-01\n\n    Public Domain.\n\n    NO WARRANTY EXPRESSED OR IMPLIED. USE AT YOUR OWN RISK.\n\n    This code should be minified before deployment.\n    See http://javascript.crockford.com/jsmin.html\n\n    USE YOUR OWN COPY. IT IS EXTREMELY UNWISE TO LOAD CODE FROM SERVERS YOU DO\n    NOT CONTROL.\n*//*jslint eval, for *//*property\n    $ref, decycle, forEach, isArray, keys, length, push, retrocycle, stringify,\n    test\n*/var origJSON=global.JSON,JSON={};module.exports=JSON;if(typeof JSON.decycle!==\"function\"){JSON.decycle=function decycle(object,replacer){\"use strict\";// Make a deep copy of an object or array, assuring that there is at most\n// one instance of each object or array in the resulting structure. The\n// duplicate references (which might be forming cycles) are replaced with\n// an object of the form\n//      {\"$ref\": PATH}\n// where the PATH is a JSONPath string that locates the first occurance.\n// So,\n//      var a = [];\n//      a[0] = a;\n//      return JSON.stringify(JSON.decycle(a));\n// produces the string '[{\"$ref\":\"$\"}]'.\n// If a replacer function is provided, then it will be called for each value.\n// A replacer function receives a value and returns a replacement value.\n// JSONPath is used to locate the unique object. $ indicates the top level of\n// the object or array. [NUMBER] or [STRING] indicates a child element or\n// property.\nvar objects=[];// Keep a reference to each unique object or array\nvar paths=[];// Keep the path to each unique object or array\nreturn function derez(value,path){// The derez function recurses through the object, producing the deep copy.\nvar i;// The loop counter\nvar nu;// The new object or array\n// If a replacer function was provided, then call it to get a replacement value.\nif(replacer!==undefined){value=replacer(value);}// typeof null === \"object\", so go on if this value is really an object but not\n// one of the weird builtin objects.\nif((typeof value===\"undefined\"?\"undefined\":(0,_typeof3.default)(value))===\"object\"&&value!==null&&!(value instanceof Boolean)&&!(value instanceof Date)&&!(value instanceof Number)&&!(value instanceof RegExp)&&!(value instanceof String)){// If the value is an object or array, look to see if we have already\n// encountered it. If so, return a {\"$ref\":PATH} object. This is a hard\n// linear search that will get slower as the number of unique objects grows.\n// Someday, this should be replaced with an ES6 WeakMap.\ni=objects.indexOf(value);if(i>=0){return{$ref:paths[i]};}// Otherwise, accumulate the unique value and its path.\nobjects.push(value);paths.push(path);// If it is an array, replicate the array.\nif(Array.isArray(value)){nu=[];value.forEach(function(element,i){nu[i]=derez(element,path+\"[\"+i+\"]\");});}else{// If it is an object, replicate the object.\nnu={};(0,_keys2.default)(value).forEach(function(name){nu[name]=derez(value[name],path+\"[\"+JSON.stringify(name)+\"]\");});}return nu;}return value;}(object,\"$\");};}if(typeof JSON.retrocycle!==\"function\"){JSON.retrocycle=function retrocycle($){\"use strict\";// Restore an object that was reduced by decycle. Members whose values are\n// objects of the form\n//      {$ref: PATH}\n// are replaced with references to the value found by the PATH. This will\n// restore cycles. The object will be mutated.\n// The eval function is used to locate the values described by a PATH. The\n// root object is kept in a $ variable. A regular expression is used to\n// assure that the PATH is extremely well formed. The regexp contains nested\n// * quantifiers. That has been known to have extremely bad performance\n// problems on some browsers for very long strings. A PATH is expected to be\n// reasonably short. A PATH is allowed to belong to a very restricted subset of\n// Goessner's JSONPath.\n// So,\n//      var s = '[{\"$ref\":\"$\"}]';\n//      return JSON.retrocycle(JSON.parse(s));\n// produces an array containing a single element which is the array itself.\nvar px=/^\\$(?:\\[(?:\\d+|\\\"(?:[^\\\\\\\"\\u0000-\\u001f]|\\\\([\\\\\\\"\\/bfnrt]|u[0-9a-zA-Z]{4}))*\\\")\\])*$/;(function rez(value){// The rez function walks recursively through the object looking for $ref\n// properties. When it finds one that has a value that is a path, then it\n// replaces the $ref object with a reference to the value that is found by\n// the path.\nif(value&&(typeof value===\"undefined\"?\"undefined\":(0,_typeof3.default)(value))===\"object\"){if(Array.isArray(value)){value.forEach(function(element,i){if((typeof element===\"undefined\"?\"undefined\":(0,_typeof3.default)(element))===\"object\"&&element!==null){var path=element.$ref;if(typeof path===\"string\"&&px.test(path)){value[i]=eval(path);}else{rez(element);}}});}else{(0,_keys2.default)(value).forEach(function(name){var item=value[name];if((typeof item===\"undefined\"?\"undefined\":(0,_typeof3.default)(item))===\"object\"&&item!==null){var path=item.$ref;if(typeof path===\"string\"&&px.test(path)){value[name]=eval(path);}else{rez(item);}}});}}})($);return $;};}JSON=origJSON;\n\n/***/ }),\n/* 17 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\nObject.defineProperty(exports,\"__esModule\",{value:true});var _utils=__webpack_require__(4);var _utils2=_interopRequireDefault(_utils);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var BUNYAN_TRACE=10;var BUNYAN_DEBUG=20;var BUNYAN_INFO=30;var BUNYAN_WARN=40;var BUNYAN_ERROR=50;var BUNYAN_FATAL=60;var levelFromName={'trace':BUNYAN_TRACE,'debug':BUNYAN_DEBUG,'info':BUNYAN_INFO,'warn':BUNYAN_WARN,'error':BUNYAN_ERROR,'fatal':BUNYAN_FATAL};var nameFromLevel=_utils2.default.invert(levelFromName);exports.default=function(inst){return{write:function write(rec){rec=JSON.parse(rec);inst._sendMessage({method:nameFromLevel[rec.level]||'info',args:[rec.msg,rec]});}};};\n\n/***/ }),\n/* 18 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\nvar _typeof2=__webpack_require__(6);var _typeof3=_interopRequireDefault(_typeof2);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}module.exports={isObject:function isObject(value){var type=typeof value==='undefined'?'undefined':(0,_typeof3.default)(value);return!!value&&(type=='object'||type=='function');},invert:function invert(obj){var inverted={};for(var k in obj){if(obj.hasOwnProperty(k)){inverted[obj[k]]=k;}}return inverted;}};\n\n/***/ }),\n/* 19 */\n/***/ (function(module, exports) {\n\nmodule.exports = require(\"source-map-support\");\n\n/***/ }),\n/* 20 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\nObject.defineProperty(exports,\"__esModule\",{value:true});var _restify=__webpack_require__(21);var _restify2=_interopRequireDefault(_restify);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}exports.default=function(options){var server=_restify2.default.createServer();server.pre(_restify2.default.pre.userAgentConnection());server.use(_restify2.default.gzipResponse());server.use(_restify2.default.CORS({credentials:true}));server.get(/.*/,_restify2.default.serveStatic({directory:__dirname,default:'index.html'}));return server;};\n\n/***/ }),\n/* 21 */\n/***/ (function(module, exports) {\n\nmodule.exports = require(\"restify\");\n\n/***/ }),\n/* 22 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\nObject.defineProperty(exports,\"__esModule\",{value:true});var _lodash=__webpack_require__(3);var _lodash2=_interopRequireDefault(_lodash);var _socket=__webpack_require__(23);var _socket2=_interopRequireDefault(_socket);var _commandManager=__webpack_require__(7);var _commandManager2=_interopRequireDefault(_commandManager);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}exports.default=function(options){var io=void 0,ns=void 0;var userManager=options.userManager;if(typeof options.server==='function'){io=(0,_socket2.default)(options.server);}else{io=(0,_socket2.default)();io.attach(options.server);}ns=io.of('/nm');ns.on('connection',function(socket){var cmdMan=null;socket.emit('settings',options.clientSettings);socket.emit('auth');socket.on('auth',function(creds){userManager.verifyUser(creds.username,creds.password).then(function(result){socket.emit('authResponse',result,result?undefined:'Incorrect password');if(result){socket.username=creds.username;socket.join('authed');if(options.onAuth){options.onAuth(socket);}}}).catch(function(err){socket.emit('authResponse',false,err);});});socket.on('cmd',function(cmdId,command){if(!socket.username){socket.emit('cmdResponse',cmdId,'You are not authorized to run commands');return;}if(!cmdMan){cmdMan=createCmdMan(options.cmdManager,socket);}cmdMan.runCmd(command,socket.username).then(function(output){socket.emit('cmdResponse',cmdId,null,output);}).catch(function(err){socket.emit('cmdResponse',cmdId,err&&err.message||err,null);});});});_lodash2.default.each(options.handlers,function(handler,event){io.on(event,handler);});return ns;};function createCmdMan(cmdManager,socket){var promptId=0,prompts={};var cmdManOpts={writeLn:null,write:function write(val,opts){if(!val)return;socket.emit('console',{method:'log',args:[val]});},error:function error(val,opts){if(!val)return;socket.emit('console',{method:'error',args:[val]});},prompt:function prompt(promptTxt,opts,cb){if(typeof opts==='function'){cb=opts;opts=undefined;}opts||(opts={});var pid=promptId++;socket.emit('prompt',pid,promptTxt,opts);prompts[pid]=cb;}};cmdManOpts.writeLn=cmdManOpts.write;socket.on('promptResponse',function(promptId,response){if(prompts[promptId]){prompts[promptId](null,response);}});return cmdManager.bindI(cmdManOpts);}\n\n/***/ }),\n/* 23 */\n/***/ (function(module, exports) {\n\nmodule.exports = require(\"socket.io\");\n\n/***/ }),\n/* 24 */\n/***/ (function(module, exports) {\n\nmodule.exports = require(\"minimist\");\n\n/***/ }),\n/* 25 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\nObject.defineProperty(exports,\"__esModule\",{value:true});var _stringify=__webpack_require__(9);var _stringify2=_interopRequireDefault(_stringify);var _keys=__webpack_require__(1);var _keys2=_interopRequireDefault(_keys);var _getIterator2=__webpack_require__(5);var _getIterator3=_interopRequireDefault(_getIterator2);var _assign=__webpack_require__(0);var _assign2=_interopRequireDefault(_assign);var _fs=__webpack_require__(2);var _fs2=_interopRequireDefault(_fs);var _tty=__webpack_require__(26);var _tty2=_interopRequireDefault(_tty);var _pty=__webpack_require__(27);var _pty2=_interopRequireDefault(_pty);var _ssh=__webpack_require__(28);var _ssh2=_interopRequireDefault(_ssh);var _terminalKit=__webpack_require__(29);var _terminalKit2=_interopRequireDefault(_terminalKit);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function SSHManager(options){this.options=options=(0,_assign2.default)({host:'127.0.0.1',port:50501,title:'Node Monkey',prompt:'Node Monkey:',silent:false},options);this.clients={};this.clientId=1;this.server=_ssh2.default.Server({hostKeys:options.hostKeys.map(function(file){return _fs2.default.readFileSync(file);})},this.onClient.bind(this));var monkey=this.options.monkey;this.server.listen(options.port,options.host,function(){options.silent||monkey.local.log('SSH listening on '+this.address().port);});}(0,_assign2.default)(SSHManager.prototype,{shutdown:function shutdown(){var clients=this.clients;var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=(0,_getIterator3.default)(clients),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var c=_step.value;c.write('\\nShutting down');c.close();}}catch(err){_didIteratorError=true;_iteratorError=err;}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally{if(_didIteratorError){throw _iteratorError;}}}},onClient:function onClient(client){var _this=this;var clientId=clientId++;this.clients[clientId]=new SSHClient({client:client,cmdManager:this.options.cmdManager,userManager:this.options.userManager,title:this.options.title,prompt:this.options.prompt,onClose:function onClose(){return delete _this.clients[clientId];}});}});function SSHClient(options){this.options=options;this.client=options.client;this.cmdMan=null;this.userManager=options.userManager;this.session=null;this.stream=null;this.pty=null;this.term=null;this.ptyInfo=null;this.title=options.title;this.promptTxt=options.prompt+' ';this.inputActive=false;this.cmdHistory=[];this.username=null;this.client.on('authentication',this.onAuth.bind(this));this.client.on('ready',this.onReady.bind(this));this.client.on('end',this.onClose.bind(this));}(0,_assign2.default)(SSHClient.prototype,{_initCmdMan:function _initCmdMan(){var _this2=this;var cmdManOpts={writeLn:null,write:function write(val,opts){opts||(opts={});val||(val='');if(opts.bold){_this2.term.bold(val);}else{_this2.term(val);}if(opts.newline){_this2.term.nextLine();}},error:function error(val,opts){opts||(opts={});// TODO: Apparently by sending this to stdout there is a timing issue and anything sent to\n//       stdout appears before this value is sent to stderr for some reason.\n// this.term.red.error(val)\n_this2.term.red(val);if(opts.newline){_this2.term.nextLine();}},prompt:function prompt(){var promptTxt=arguments.length>0&&arguments[0]!==undefined?arguments[0]:'';var opts=arguments[1];var cb=arguments[2];if(typeof opts==='function'){cb=opts;opts=undefined;}opts||(opts={});var inputOpts={};if(opts.hideInput){inputOpts.echo=false;}_this2.term(promptTxt);_this2.term.inputField(inputOpts,cb);}};cmdManOpts.writeLn=function(val,opts){opts||(opts={});opts.newline=true;cmdManOpts.write(val,opts);};this.cmdMan=this.options.cmdManager.bindI(cmdManOpts);},write:function write(msg,opts){opts||(opts={});if(this.term){if(opts.style){this.term[style](msg);}else{this.term(msg);}}},close:function close(){if(this.stream){this.stream.end();}this.onClose();},onAuth:function onAuth(ctx){var _this3=this;if(ctx.method=='password'){this.userManager.verifyUser(ctx.username,ctx.password).then(function(result){if(result){_this3.username=ctx.username;ctx.accept();}else{ctx.reject();}}).catch(function(err){ctx.reject();});}else if(ctx.method=='publickey'){ctx.reject();}else{ctx.reject();}},onReady:function onReady(){var _this4=this;this.client.on('session',function(accept,reject){_this4.session=accept();_this4.session.once('pty',function(accept,reject,info){_this4.ptyInfo=info;accept&&accept();}).on('window-change',function(accept,reject,info){(0,_assign2.default)(_this4.ptyInfo,info);_this4._resize();accept&&accept();}).once('shell',function(accept,reject){_this4.stream=accept();_this4._initCmdMan();_this4._initStream();_this4._initPty();_this4._initTerm();});});},onClose:function onClose(){var onClose=this.options.onClose;onClose&&onClose();},onKey:function onKey(name,matches,data){var _this5=this;if(name==='CTRL_L'){this.clearScreen();}else if(name==='CTRL_C'){this.inputActive=false;this.inputField.abort();this.term('\\n^^C\\n');this.prompt();}else if(name==='CTRL_D'){var input=this.inputField.getInput();if(!input.length){this.term.nextLine();setTimeout(function(){_this5.close();},0);}}},_resize:function _resize(){var term=this.term;if(this.term){this.term.stdout.emit('resize');}},_initStream:function _initStream(){var stream=this.stream;stream.name=this.title;stream.isTTY=true;stream.setRawMode=function(){};stream.on('error',function(error){console.error('SSH stream error:',error.message);});},_initPty:function _initPty(){var _this6=this;var newPty=_pty2.default.native.open(this.ptyInfo.cols,this.ptyInfo.rows);this.pty={master_fd:newPty.master,slave_fd:newPty.slave,master:new _tty2.default.WriteStream(newPty.master),slave:new _tty2.default.ReadStream(newPty.slave)};this.pty.slave.getWindowSize=function(){return[_this6.ptyInfo.cols,_this6.ptyInfo.rows];};this.stream.stdin.pipe(this.pty.master);this.pty.master.pipe(this.stream.stdout);},_initTerm:function _initTerm(){var stream=this.stream;var term=this.term=_terminalKit2.default.createTerminal({stdin:this.pty.slave,stdout:this.pty.slave,stderr:this.pty.slave,generic:this.ptyInfo.term,appName:this.title});term.on('key',this.onKey.bind(this));term.windowTitle(this._interpolate(this.title));this.clearScreen();},_interpolate:function _interpolate(str){var varRe=/{@(.+?)}/g;var vars={username:this.username};var match=void 0;while(match=varRe.exec(str)){if(vars[match[1]]){str=str.replace(match[0],vars[match[1]]);}}return str;},clearScreen:function clearScreen(){this.term.clear();this.prompt();},prompt:function prompt(){var _this7=this;var term=this.term;term.windowTitle(this._interpolate(this.title));term.bold(this._interpolate(this.promptTxt));if(!this.inputActive){this.inputActive=true;this.inputField=term.inputField({history:this.cmdHistory,autoComplete:(0,_keys2.default)(this.cmdMan.commands),autoCompleteMenu:true},function(error,input){_this7.inputActive=false;term.nextLine();if(error){return term.error(error.message||error);}if(!input){return _this7.prompt();}input[0]!==' '&&_this7.cmdHistory.push(input);if(input==='exit'){// This is delayed briefly so the newline can be echoed to the client, creating cleaner output when exiting\nsetTimeout(_this7.close.bind(_this7));}else if(input==='clear'){_this7.clearScreen();}else if(input){_this7.cmdMan.runCmd(input,_this7.username).then(function(output){if(typeof output!=='string'){output=(0,_stringify2.default)(output,null,'  ');}_this7.term(output);_this7.term.nextLine();_this7.prompt();}).catch(function(err){if(typeof err!=='string'){err=err.message||(0,_stringify2.default)(err,null,'  ');}_this7.term.red.error(err);_this7.term.nextLine();_this7.prompt();});}else{_this7.prompt();}});}}});exports.default=SSHManager;\n\n/***/ }),\n/* 26 */\n/***/ (function(module, exports) {\n\nmodule.exports = require(\"tty\");\n\n/***/ }),\n/* 27 */\n/***/ (function(module, exports) {\n\nmodule.exports = require(\"pty.js\");\n\n/***/ }),\n/* 28 */\n/***/ (function(module, exports) {\n\nmodule.exports = require(\"ssh2\");\n\n/***/ }),\n/* 29 */\n/***/ (function(module, exports) {\n\nmodule.exports = require(\"terminal-kit\");\n\n/***/ }),\n/* 30 */\n/***/ (function(module, exports, __webpack_require__) {\n\n\"use strict\";\nObject.defineProperty(exports,\"__esModule\",{value:true});var _promise=__webpack_require__(8);var _promise2=_interopRequireDefault(_promise);var _stringify=__webpack_require__(9);var _stringify2=_interopRequireDefault(_stringify);var _assign=__webpack_require__(0);var _assign2=_interopRequireDefault(_assign);var _keys=__webpack_require__(1);var _keys2=_interopRequireDefault(_keys);var _fs=__webpack_require__(2);var _fs2=_interopRequireDefault(_fs);var _scrypt=__webpack_require__(31);var _scrypt2=_interopRequireDefault(_scrypt);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var useNew=false;try{Buffer.from('','base64');}catch(err){useNew=true;}function stringToBuffer(string,base){if(useNew){return new Buffer(string,base);}else{return Buffer.from(string,base);}}function UserManager(options){this.userFile=options.userFile;this.userFileCache=null;this.userFileCreated=false;if(!options.silent){this.getUsers().then(function(users){var usernames=(0,_keys2.default)(users);if(!usernames.length){if(process.env.NODE_ENV==='production'){console.warn('No users have been created and you are running in production mode so you will not be able to login.\\n');}else{console.warn('It seems there are no users and you are not running in production mode so you will not be able to login. This is probably a bug. Please report it!\\n');}}else if(usernames.length===1&&usernames[0]==='guest'){console.warn('[WARN] No users detected. You can login with default user \\'guest\\' and password \\'guest\\' when prompted.\\n'+'This user will be disabled when you create a user account.\\n');}});}}(0,_assign2.default)(UserManager.prototype,{_readFile:function _readFile(){var _this=this;if(this.userFileCache){return this.userFileCache;}try{if(!this.userFile){var err=new Error('No user file specified');err.code='ENOENT';throw err;}this.userFileCache=JSON.parse(_fs2.default.readFileSync(this.userFile));this.userFileCreated=true;setTimeout(function(){_this.userFileCache=null;},5000);return this.userFileCache;}catch(err){if(err.code==='ENOENT'){return process.env.NODE_ENV==='production'?{}:{guest:{password:'c2NyeXB0AAEAAAABAAAAAZS+vE1+zh4nY6vN21zM3dIzpJVImr8OrK0iJoA+iUPk7WIdo3RhgeATzWENocd7gKNbEKVgq6LbXqrmVjLtnYy5FXyfRCtEtmjUuj19AqcW'}};}throw err;}},_writeFile:function _writeFile(data){this.userFileCache=null;_fs2.default.writeFileSync(this.userFile,(0,_stringify2.default)(data,null,'  '));this.userFileCreated=true;},_hashPassword:function _hashPassword(passwd){return _scrypt2.default.kdfSync(passwd.normalize('NFKC'),{N:1,r:1,p:1}).toString('base64');},_verifyPassword:function _verifyPassword(hash,passwd){return _scrypt2.default.verifyKdfSync(stringToBuffer(hash,'base64'),passwd.normalize('NFKC'));},createUser:function createUser(username,password){var _this2=this;return new _promise2.default(function(resolve,reject){if(!_this2.userFile){return reject(new Error('No user file found. Did you forget to set the \\'dataDir\\' option?'));}var users=_this2._readFile();if(users[username]){return reject(new Error('User \\''+username+'\\' already exists'));}if(!_this2.userFileCreated){delete users['guest'];}users[username]={password:_this2._hashPassword(password)};_this2._writeFile(users);resolve();});},deleteUser:function deleteUser(username){var _this3=this;return new _promise2.default(function(resolve,reject){if(!_this3.userFile){return reject(new Error('No user file found. Did you forget to set the \\'dataDir\\' option?'));}var users=_this3._readFile();if(!users[username]){return reject(new Error('User \\''+username+'\\' does not exist'));}if(!_this3.userFileCreated){return reject(new Error('User file has not been created'));}delete users[username];_this3._writeFile(users);resolve();});},setPassword:function setPassword(username,password){var _this4=this;return new _promise2.default(function(resolve,reject){if(!_this4.userFile){return reject(new Error('No user file found. Did you forget to set the \\'dataDir\\' option?'));}var users=_this4._readFile();users[username].password=_this4._hashPassword(password);_this4._writeFile(users);resolve();});},getUsers:function getUsers(){var _this5=this;return new _promise2.default(function(resolve,reject){resolve(_this5._readFile());});},getUserData:function getUserData(username){var _this6=this;return new _promise2.default(function(resolve,reject){var users=_this6._readFile();if(!users[username]){return reject(new Error('User \\''+username+'\\' does not exist'));}resolve(users[username]);});},verifyUser:function verifyUser(username,passwd){var _this7=this;return new _promise2.default(function(resolve,reject){_this7.getUserData(username).then(function(userData){resolve(_this7._verifyPassword(userData.password,passwd));}).catch(reject);});}});exports.default=UserManager;\n\n/***/ }),\n/* 31 */\n/***/ (function(module, exports) {\n\nmodule.exports = require(\"scrypt\");\n\n/***/ })\n/******/ ]);\n\n\n// WEBPACK FOOTER //\n// server.js"," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 10);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap fd9cd82cc1c23683b04a","module.exports = require(\"babel-runtime/core-js/object/assign\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"babel-runtime/core-js/object/assign\"\n// module id = 0\n// module chunks = 0","module.exports = require(\"babel-runtime/core-js/object/keys\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"babel-runtime/core-js/object/keys\"\n// module id = 1\n// module chunks = 0","module.exports = require(\"fs\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"fs\"\n// module id = 2\n// module chunks = 0","module.exports = require(\"lodash\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"lodash\"\n// module id = 3\n// module chunks = 0","import commonUtils from '../lib/common-utils'\nimport sourceMapSupport from 'source-map-support'\n\nexport default Object.assign({\n  parseCommand(str) {\n    const reg = /\"(.*?)\"|'(.*?)'|`(.*?)`|([^\\s\"]+)/gi\n    let arr = [],\n        match\n\n    do {\n      match = reg.exec(str)\n      if (match !== null) {\n        arr.push(match[1] || match[2] || match[3] || match[4])\n      }\n    } while (match !== null)\n\n    return arr\n  },\n\n  getStack() {\n    let prep = Error.prepareStackTrace\n    let limit = Error.stackTraceLimit\n    Error.prepareStackTrace = (error, trace) => trace.map(sourceMapSupport.wrapCallSite)\n    Error.stackTraceLimit = 30\n\n    let stack = new Error().stack\n    Error.prepareStackTrace = prep\n    Error.stackTraceLimit = limit\n\n    return stack.slice(1)\n  }\n}, commonUtils)\n\n\n// WEBPACK FOOTER //\n// ./server/utils.js","module.exports = require(\"babel-runtime/core-js/get-iterator\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"babel-runtime/core-js/get-iterator\"\n// module id = 5\n// module chunks = 0","module.exports = require(\"babel-runtime/helpers/typeof\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"babel-runtime/helpers/typeof\"\n// module id = 6\n// module chunks = 0","import _ from 'lodash'\nimport utils from './utils'\nimport minimist from 'minimist'\n\nfunction CommandManager() {\n  this.commands = {}\n}\n\nObject.assign(CommandManager.prototype, {\n  addCmd(cmdName, opts, exec) {\n    if (this.commands[cmdName]) {\n      throw new Error(`'${cmdName}' is already registered as a command`)\n    }\n\n    if (typeof opts === 'function') {\n      exec = opts\n      opts = {}\n    }\n\n    this.commands[cmdName] = {\n      opts,\n      exec\n    }\n  },\n\n  bindI(ioInterface) {\n    let boundI = _.mapValues(this)\n    Object.assign(boundI, _.mapValues(this.constructor.prototype, (val, key) => {\n      if (val instanceof Function) {\n        if (key === 'runCmd') {\n          return val.bind(this, ioInterface)\n        }\n        return val.bind(this)\n      } else {\n        return val\n      }\n    }))\n\n    return boundI\n  },\n\n  runCmd(io, rawCommand, asUser) {\n    return new Promise((resolve, reject) => {\n      let parsed = utils.parseCommand(rawCommand),\n          cmdName = parsed[0],\n          cmd = this.commands[cmdName]\n\n      if (!asUser) {\n        return reject(`Missing user context for command '${cmdName}'`)\n      }\n\n      if (!cmd) {\n        return reject(`Command not found: '${cmdName}'`)\n      }\n\n      let args = minimist(parsed.slice(1))\n      cmd.exec({\n          args,\n          username: asUser\n        }, {\n          write: io.write,\n          writeLn: io.writeLn,\n          error: io.error,\n          prompt: io.prompt\n        },\n        resolve\n      )\n    })\n  }\n})\n\n\nexport default CommandManager\n\n\n// WEBPACK FOOTER //\n// ./server/command-manager.js","module.exports = require(\"babel-runtime/core-js/promise\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"babel-runtime/core-js/promise\"\n// module id = 8\n// module chunks = 0","module.exports = require(\"babel-runtime/core-js/json/stringify\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"babel-runtime/core-js/json/stringify\"\n// module id = 9\n// module chunks = 0","import os from 'os'\nimport fs from 'fs'\nimport path from 'path'\nimport EventEmitter from 'events'\nimport { execSync } from 'child_process'\nimport _ from 'lodash'\nimport keypair from 'keypair'\nimport cycle from '../lib/cycle'\nimport bunyanStream from './bunyan-stream'\nimport setupServer from './setup-server'\nimport setupSocket from './setup-socket'\nimport SSHMan from './ssh-manager'\nimport CmdMan from './command-manager'\nimport UserManager from './user-manager'\nimport utils from './utils'\n\nconst DEFAULT_PORT = 50500\nconst CONSOLE = _.mapValues(console)\nconst ConsoleEvent = new EventEmitter()\nconst HANDLE_TYPES = [ 'log', 'info', 'warn', 'error', 'dir' ]\n\nlet attachedCount = 0\n\nfunction NodeMonkey(opts) {\n  const NODE_ENV = process.NODE_ENV\n  let options = this.options = _.merge({\n    server: {\n      // You can provide your own server and Node Monkey will use it instead of creating its own.\n      // However, this MUST be the underlying http server instance, not the express/restify/whatever app.\n      server: null,\n\n      host: '0.0.0.0',\n      port: DEFAULT_PORT,\n      silent: false,\n      bufferSize: 50,\n      attachOnStart: true,\n\n      // Only takes effect when Node Monkey is attached to the console\n      disableLocalOutput: false\n    },\n    client: {\n      showCallerInfo: NODE_ENV === 'production' ? false : true,\n      convertStyles: true\n    },\n    ssh: {\n      enabled: false,\n      host: '0.0.0.0',\n      port: DEFAULT_PORT + 1,\n      title: `Node Monkey on ${os.hostname()}`,\n      prompt: `[Node Monkey] {@username}@${os.hostname()}:`\n    },\n\n    // Needed for storing things like user files and SSH host keys\n    dataDir: null\n  }, opts)\n\n  this.msgBuffer = []\n  this.BUNYAN_STREAM = bunyanStream(this)\n  this._attached = false\n  this._typeHandlers = {}\n\n  this._createLocal()\n  this._createRemote()\n  this._setupCmdMan()\n  this._setupUserManager()\n  this._setupServer()\n  this._setupSSH()\n\n  if (options.server.attachOnStart) {\n    this.attachConsole()\n  }\n\n  // TODO: Deprecated. Remove everything after this line by v1.0.0\n  let self = this\n  let warned = false\n  function warnConsole() {\n    if (!warned) {\n      warned = true\n      let warningMsg = [\n        `[Deprecation Warning] Running Node Monkey with 'augmentConsole' enabled.`,\n        `This is strongly discouraged and will be removed in the v1.0.0 release.`,\n        `See here for more info: https://github.com/jwarkentin/node-monkey/releases/tag/v1.0.0-rc.1`\n      ].join(' ')\n      self.local.warn(warningMsg)\n      self.remote.warn(warningMsg)\n    }\n  }\n\n  // This is here because webpack renames the function and for whatever reason the stack trace doesn't show the right name,\n  // even with proper source maps. This is all just temporary anyway so I'm hacking it.\n  Object.defineProperty(warnConsole, 'name', { value: 'warnConsole' })\n\n  console.local = _.mapValues(this.local, (fn, method) => {\n    let localFn = function() {\n      warnConsole()\n      return fn.apply(console, arguments)\n    }\n    Object.defineProperty(localFn, 'name', { value: method })\n    return localFn\n  })\n  console.remote = _.mapValues(this.remote, (fn, method) => {\n    let remoteFn = function() {\n      warnConsole()\n      return fn.apply({ callerStackDistance: 2 }, arguments)\n    }\n    Object.defineProperty(remoteFn, 'name', { value: method })\n    return remoteFn\n  })\n}\n\n_.assign(NodeMonkey.prototype, {\n  _getServerProtocol(server) {\n    if (server._events && server._events.tlsClientError) {\n      return 'https'\n    }\n    return 'http'\n  },\n\n  getServerPaths() {\n    let basePath = path.normalize(`${__dirname}/../dist`)\n\n    return {\n      basePath,\n      client: 'monkey.js',\n      index: 'index.html'\n    }\n  },\n\n  _displayServerWelcome() {\n    if (!this.options.server.silent) {\n      let server = this.options.server.server\n      if (server.listening) {\n        let proto = this._getServerProtocol(server)\n        let { address, port } = server.address()\n        this.local.log(`Node Monkey listening at ${proto}://${address}:${port}`)\n      } else {\n        server.on('listening', this._displayServerWelcome.bind(this))\n      }\n    }\n  },\n\n  _setupCmdMan() {\n    this._cmdMan = new CmdMan()\n    let cmdMan = this.cmdMan = this._cmdMan.bindI({\n      write: (val, opts) => {\n        console.log(val)\n      },\n      writeLn: (val, opts) => {\n        console.log(val)\n      },\n      error: (val, opts) => {\n        console.error(val)\n      },\n      prompt: (promptTxt, opts, cb) => {\n        if (typeof opts === 'function') {\n          cb = opts\n          opts = undefined\n        }\n        opts || (opts = {})\n\n        console.warn('Prompt not implemented')\n      }\n    })\n\n    this.addCmd = cmdMan.addCmd\n    this.runCmd = cmdMan.runCmd\n  },\n\n  _setupUserManager() {\n    let dataDir = this.options.dataDir\n    let userMan = this.userManager = new UserManager({\n      userFile: dataDir ? `${dataDir}/users.json` : undefined,\n      silent: this.options.server.silent\n    })\n\n    this.cmdMan.addCmd('showusers', (opts, term, done) => {\n      let users = userMan.getUsers().then(users => {\n        term.writeLn(Object.keys(users).join('\\n'))\n        done()\n      })\n    })\n\n    this.cmdMan.addCmd('adduser', (opts, term, done) => {\n      let args = opts.args,\n          username = args._[0]\n\n      if (!username) {\n        term.error(`You must specify a username`)\n        return done()\n      }\n\n      term.prompt('Password: ', { hideInput: true }, (error, password) => {\n        term.writeLn()\n        term.prompt('Again: ', { hideInput: true }, (error, passwordAgain) => {\n          term.writeLn()\n          if (password === passwordAgain) {\n            userMan.createUser(username, password)\n              .then(() => term.write(`Created user '${username}'`))\n              .catch(term.error)\n              .then(done)\n          } else {\n            term.error('Passwords do not match')\n            done()\n          }\n        })\n      })\n    })\n\n    this.cmdMan.addCmd('deluser', (opts, term, done) => {\n      let args = opts.args,\n          username = args._[0]\n\n      if (!username) {\n        term.error(`You must specify a username`)\n        return done()\n      }\n\n      userMan.deleteUser(username)\n        .then(() => term.write(`Deleted user '${username}'`))\n        .catch(term.error)\n        .then(done)\n    })\n\n    this.cmdMan.addCmd('passwd', (opts, term, done) => {\n      let args = opts.args,\n          user = opts.username\n\n      term.prompt('Current password: ', { hideInput: true }, (error, curpwd) => {\n        term.writeLn()\n        userMan.verifyUser(user, curpwd).then(matches => {\n          if (matches) {\n            term.prompt('Password: ', { hideInput: true }, (error, password) => {\n              term.writeLn()\n              term.prompt('Again: ', { hideInput: true }, (error, passwordAgain) => {\n                term.writeLn()\n                if (password === passwordAgain) {\n                  userMan.setPassword(user, password)\n                    .then(() => term.write(`Updated password for ${user}`))\n                    .catch(term.error)\n                    .then(done)\n                } else {\n                  term.error('Passwords do not match')\n                  done()\n                }\n              })\n            })\n          } else {\n            term.error('Incorrect password')\n            done()\n          }\n        })\n      })\n    })\n  },\n\n  _setupServer() {\n    let options = this.options,\n        server = options.server.server\n\n    if (!server) {\n      let serverApp = setupServer({\n        name: 'Node Monkey'\n      })\n      server = this.options.server.server = serverApp.server\n\n      let { host, port } = options.server\n      serverApp.listen(port, host)\n    }\n\n    this._displayServerWelcome()\n    this.serverApp = server\n    this.remoteClients = setupSocket({\n      server: server.server || server,\n      cmdManager: this._cmdMan,\n      userManager: this.userManager,\n      onAuth: this._sendMessages.bind(this),\n      clientSettings: options.client\n    })\n  },\n\n  _setupSSH() {\n    let sshOpts = this.options.ssh\n    if (sshOpts.enabled) {\n      let dataDir = this.options.dataDir\n      if (!dataDir) {\n        throw new Error(`Options 'dataDir' is required to enable SSH`)\n      }\n\n      // Get host keys\n      let files = fs.readdirSync(dataDir),\n          keyRe = /\\.key$/,\n          hostKeys = []\n      for (let file of files) {\n        if (keyRe.test(file)) {\n          hostKeys.push(`${dataDir}/${file}`)\n        }\n      }\n\n      if (!hostKeys.length) {\n        console.log('No SSH host key found. Generating new host key...')\n        let keys = keypair()\n        fs.writeFileSync(`${dataDir}/rsa.key`, keys.private)\n        fs.writeFileSync(`${dataDir}/rsa.key.pub`, keys.public)\n        hostKeys = [ `${dataDir}/rsa.key` ]\n      }\n\n      this.SSHMan = new SSHMan({\n        monkey: this,\n        cmdManager: this._cmdMan,\n        userManager: this.userManager,\n        silent: this.options.server.silent,\n        host: sshOpts.host,\n        port: sshOpts.port,\n        title: _.result(sshOpts, 'title'),\n        prompt: _.result(sshOpts, 'prompt'),\n        hostKeys\n      })\n    }\n  },\n\n  // TODO: This whole process of trying to identify the true source of the call is so fucking messy and fragile. Need to think\n  //       of a better way to identify the call source and rewrite all this shitty code handling it right now.\n  _getCallerInfo(callerStackDistance) {\n    if (this.options.client.showCallerInfo) {\n      let stack = utils.getStack().map(frame => {\n        return {\n          functionName: frame.getFunctionName(),\n          methodName: frame.getMethodName(),\n          fileName: frame.getFileName(),\n          lineNumber: frame.getLineNumber(),\n          columnNumber: frame.getColumnNumber()\n        }\n      })\n\n      let caller = stack.find((frame, index, stack) => {\n        // We're either looking for a console method call or a bunyan log call. This logic will break down if method names change.\n        let twoBack = stack[index - 2]\n        let sixBack = stack[index - 4]\n        if (twoBack && twoBack.functionName === 'Logger._emit' && /\\/bunyan\\.js$/.test(twoBack.fileName)) {\n          return true\n        } else if (twoBack && sixBack && twoBack.methodName === 'emit' && sixBack.methodName === '_sendMessage') {\n          return true\n        }\n      })\n\n      if (!caller && typeof callerStackDistance === 'number') {\n        caller = stack[callerStackDistance]\n      }\n\n      if (caller) {\n        return {\n          caller: caller.functionName || caller.methodName,\n          file: caller.fileName,\n          line: caller.lineNumber,\n          column: caller.columnNumber\n        }\n      }\n    }\n  },\n\n  _sendMessage(info, callerStackDistance) {\n    this.msgBuffer.push({\n      method: info.method,\n      args: info.args,\n      callerInfo: info.callerInfo || this._getCallerInfo(callerStackDistance + 1)\n    })\n    if (this.msgBuffer.length > this.options.server.bufferSize) {\n      this.msgBuffer.shift()\n    }\n    this._sendMessages()\n  },\n\n  _sendMessages() {\n    let remoteClients = this.remoteClients\n    if (_.size(remoteClients.adapter.rooms['authed'])) {\n      _.each(this.msgBuffer, info => {\n        remoteClients.to('authed').emit('console', cycle.decycle(info))\n      })\n\n      this.msgBuffer = []\n    }\n  },\n\n  _createLocal() {\n    // NOTE: The console functions here should not be wrapped since these values are used to restore the defaults\n    //       when `detachConsole()` is called.\n    this.local = CONSOLE\n  },\n\n  _createRemote() {\n    let self = this\n    let remote = this.remote = {}\n    HANDLE_TYPES.forEach(method => {\n      self.remote[method] = function() {\n        self._sendMessage({\n          method,\n          args: Array.prototype.slice.call(arguments)\n        }, this.callerStackDistance ? this.callerStackDistance + 1 : 2)\n      }\n      Object.defineProperty(remote[method], 'name', { value: method })\n    })\n  },\n\n  attachConsole(disableLocalOutput) {\n    if (this._attached) {\n      return\n    }\n\n    if (!attachedCount) {\n      // If this function is in the process of handling the log call we will try and prevent potential infinite recursion\n      let handlersActive = 0\n      HANDLE_TYPES.forEach(method => {\n        console[method] = function() {\n          if (handlersActive) {\n            return self.local[method].apply(console, arguments)\n          }\n\n          ++handlersActive\n          ConsoleEvent.emit(method, ...arguments)\n          --handlersActive\n        }\n        Object.defineProperty(console[method], 'name', { value: method })\n      })\n    }\n\n    ++attachedCount\n\n    let self = this\n    let serverOptions = this.options.server\n    disableLocalOutput = disableLocalOutput !== undefined ? disableLocalOutput : serverOptions.disableLocalOutput\n\n    _.each(this.remote, (fn, method) => {\n      let handler = this._typeHandlers[method] = function() {\n        fn.apply({ callerStackDistance: 5 }, arguments)\n\n        if (!disableLocalOutput) {\n          self.local[method].apply(console, arguments)\n        }\n      }\n      Object.defineProperty(handler, 'name', { value: method })\n\n      ConsoleEvent.on(method, handler)\n    })\n\n    this._attached = true\n  },\n\n  detachConsole() {\n    Object.assign(console, this.local)\n    this._attached = false\n    --attachedCount\n\n    HANDLE_TYPES.forEach(method => {\n      ConsoleEvent.removeListener(method, this._typeHandlers[method])\n      delete this._typeHandlers[method]\n    })\n  }\n})\n\n\nlet instances = {}\nlet lastPort = DEFAULT_PORT - 1\nmodule.exports = function createInst(options, name = 'default') {\n  if (typeof options === 'string') {\n    name = options\n    options = undefined\n  }\n\n  if (!instances[name]) {\n    options || (options = {})\n    let port = _.get(options, 'server.port')\n    if (port) {\n      lastPort = +port\n    } else {\n      _.set(options, 'server.port', ++lastPort)\n      _.set(options, 'ssh.port', ++lastPort)\n    }\n    instances[name] = new NodeMonkey(options)\n  }\n\n  return instances[name]\n}\n\n// Just exporting in case someone needs to wrap this or access the internals for some reason\nmodule.exports.NodeMonkey = NodeMonkey\n\n\n// WEBPACK FOOTER //\n// ./server/app.js","module.exports = require(\"os\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"os\"\n// module id = 11\n// module chunks = 0","module.exports = require(\"path\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"path\"\n// module id = 12\n// module chunks = 0","module.exports = require(\"events\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"events\"\n// module id = 13\n// module chunks = 0","module.exports = require(\"child_process\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"child_process\"\n// module id = 14\n// module chunks = 0","module.exports = require(\"keypair\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"keypair\"\n// module id = 15\n// module chunks = 0","/*\n    cycle.js\n    2016-05-01\n\n    Public Domain.\n\n    NO WARRANTY EXPRESSED OR IMPLIED. USE AT YOUR OWN RISK.\n\n    This code should be minified before deployment.\n    See http://javascript.crockford.com/jsmin.html\n\n    USE YOUR OWN COPY. IT IS EXTREMELY UNWISE TO LOAD CODE FROM SERVERS YOU DO\n    NOT CONTROL.\n*/\n\n/*jslint eval, for */\n\n/*property\n    $ref, decycle, forEach, isArray, keys, length, push, retrocycle, stringify,\n    test\n*/\n\nlet origJSON = global.JSON,\n    JSON = {}\nmodule.exports = JSON\n\nif (typeof JSON.decycle !== \"function\") {\n    JSON.decycle = function decycle(object, replacer) {\n        \"use strict\";\n\n// Make a deep copy of an object or array, assuring that there is at most\n// one instance of each object or array in the resulting structure. The\n// duplicate references (which might be forming cycles) are replaced with\n// an object of the form\n\n//      {\"$ref\": PATH}\n\n// where the PATH is a JSONPath string that locates the first occurance.\n\n// So,\n\n//      var a = [];\n//      a[0] = a;\n//      return JSON.stringify(JSON.decycle(a));\n\n// produces the string '[{\"$ref\":\"$\"}]'.\n\n// If a replacer function is provided, then it will be called for each value.\n// A replacer function receives a value and returns a replacement value.\n\n// JSONPath is used to locate the unique object. $ indicates the top level of\n// the object or array. [NUMBER] or [STRING] indicates a child element or\n// property.\n\n        var objects = [];   // Keep a reference to each unique object or array\n        var paths = [];     // Keep the path to each unique object or array\n\n        return (function derez(value, path) {\n\n// The derez function recurses through the object, producing the deep copy.\n\n            var i;          // The loop counter\n            var nu;         // The new object or array\n\n// If a replacer function was provided, then call it to get a replacement value.\n\n            if (replacer !== undefined) {\n                value = replacer(value);\n            }\n\n// typeof null === \"object\", so go on if this value is really an object but not\n// one of the weird builtin objects.\n\n            if (\n                typeof value === \"object\" && value !== null &&\n                !(value instanceof Boolean) &&\n                !(value instanceof Date) &&\n                !(value instanceof Number) &&\n                !(value instanceof RegExp) &&\n                !(value instanceof String)\n            ) {\n\n// If the value is an object or array, look to see if we have already\n// encountered it. If so, return a {\"$ref\":PATH} object. This is a hard\n// linear search that will get slower as the number of unique objects grows.\n// Someday, this should be replaced with an ES6 WeakMap.\n\n                i = objects.indexOf(value);\n                if (i >= 0) {\n                    return {$ref: paths[i]};\n                }\n\n// Otherwise, accumulate the unique value and its path.\n\n                objects.push(value);\n                paths.push(path);\n\n// If it is an array, replicate the array.\n\n                if (Array.isArray(value)) {\n                    nu = [];\n                    value.forEach(function (element, i) {\n                        nu[i] = derez(element, path + \"[\" + i + \"]\");\n                    });\n                } else {\n\n// If it is an object, replicate the object.\n\n                    nu = {};\n                    Object.keys(value).forEach(function (name) {\n                        nu[name] = derez(\n                            value[name],\n                            path + \"[\" + JSON.stringify(name) + \"]\"\n                        );\n                    });\n                }\n                return nu;\n            }\n            return value;\n        }(object, \"$\"));\n    };\n}\n\n\nif (typeof JSON.retrocycle !== \"function\") {\n    JSON.retrocycle = function retrocycle($) {\n        \"use strict\";\n\n// Restore an object that was reduced by decycle. Members whose values are\n// objects of the form\n//      {$ref: PATH}\n// are replaced with references to the value found by the PATH. This will\n// restore cycles. The object will be mutated.\n\n// The eval function is used to locate the values described by a PATH. The\n// root object is kept in a $ variable. A regular expression is used to\n// assure that the PATH is extremely well formed. The regexp contains nested\n// * quantifiers. That has been known to have extremely bad performance\n// problems on some browsers for very long strings. A PATH is expected to be\n// reasonably short. A PATH is allowed to belong to a very restricted subset of\n// Goessner's JSONPath.\n\n// So,\n//      var s = '[{\"$ref\":\"$\"}]';\n//      return JSON.retrocycle(JSON.parse(s));\n// produces an array containing a single element which is the array itself.\n\n        var px = /^\\$(?:\\[(?:\\d+|\\\"(?:[^\\\\\\\"\\u0000-\\u001f]|\\\\([\\\\\\\"\\/bfnrt]|u[0-9a-zA-Z]{4}))*\\\")\\])*$/;\n\n        (function rez(value) {\n\n// The rez function walks recursively through the object looking for $ref\n// properties. When it finds one that has a value that is a path, then it\n// replaces the $ref object with a reference to the value that is found by\n// the path.\n\n            if (value && typeof value === \"object\") {\n                if (Array.isArray(value)) {\n                    value.forEach(function (element, i) {\n                        if (typeof element === \"object\" && element !== null) {\n                            var path = element.$ref;\n                            if (typeof path === \"string\" && px.test(path)) {\n                                value[i] = eval(path);\n                            } else {\n                                rez(element);\n                            }\n                        }\n                    });\n                } else {\n                    Object.keys(value).forEach(function (name) {\n                        var item = value[name];\n                        if (typeof item === \"object\" && item !== null) {\n                            var path = item.$ref;\n                            if (typeof path === \"string\" && px.test(path)) {\n                                value[name] = eval(path);\n                            } else {\n                                rez(item);\n                            }\n                        }\n                    });\n                }\n            }\n        }($));\n        return $;\n    };\n}\n\nJSON = origJSON\n\n\n// WEBPACK FOOTER //\n// ./lib/cycle.js","import utils from './utils'\n\nconst BUNYAN_TRACE = 10\nconst BUNYAN_DEBUG = 20\nconst BUNYAN_INFO = 30\nconst BUNYAN_WARN = 40\nconst BUNYAN_ERROR = 50\nconst BUNYAN_FATAL = 60\n\nlet levelFromName = {\n  'trace': BUNYAN_TRACE,\n  'debug': BUNYAN_DEBUG,\n  'info': BUNYAN_INFO,\n  'warn': BUNYAN_WARN,\n  'error': BUNYAN_ERROR,\n  'fatal': BUNYAN_FATAL\n}\nlet nameFromLevel = utils.invert(levelFromName)\n\nexport default inst => {\n  return {\n    write: function(rec) {\n      rec = JSON.parse(rec)\n      inst._sendMessage({\n        method: nameFromLevel[rec.level] || 'info',\n        args: [ rec.msg, rec ]\n      })\n    }\n  }\n}\n\n\n// WEBPACK FOOTER //\n// ./server/bunyan-stream.js","module.exports = {\n  isObject(value) {\n    let type = typeof value\n    return !!value && (type == 'object' || type == 'function')\n  },\n\n  invert(obj) {\n    let inverted = {}\n    for (let k in obj) {\n      if (obj.hasOwnProperty(k)) {\n        inverted[obj[k]] = k\n      }\n    }\n\n    return inverted\n  }\n}\n\n\n// WEBPACK FOOTER //\n// ./lib/common-utils.js","module.exports = require(\"source-map-support\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"source-map-support\"\n// module id = 19\n// module chunks = 0","import restify from 'restify'\n\nexport default options => {\n  let server = restify.createServer()\n\n  server.pre(restify.pre.userAgentConnection())\n  server.use(restify.gzipResponse())\n  server.use(restify.CORS({\n    credentials: true\n  }))\n\n  server.get(/.*/, restify.serveStatic({\n    directory: __dirname,\n    default: 'index.html'\n  }))\n\n  return server\n}\n\n\n// WEBPACK FOOTER //\n// ./server/setup-server.js","module.exports = require(\"restify\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"restify\"\n// module id = 21\n// module chunks = 0","import _ from 'lodash'\nimport socketio from 'socket.io'\nimport CmdMan from './command-manager'\n\nexport default options => {\n  let io, ns\n  let userManager = options.userManager\n\n  if (typeof options.server === 'function') {\n    io = socketio(options.server)\n  } else {\n    io = socketio()\n    io.attach(options.server)\n  }\n\n  ns = io.of('/nm')\n  ns.on('connection', socket => {\n    let cmdMan = null\n    socket.emit('settings', options.clientSettings)\n    socket.emit('auth')\n\n    socket.on('auth', creds => {\n      userManager.verifyUser(creds.username, creds.password).then(result => {\n        socket.emit('authResponse', result, result ? undefined : 'Incorrect password')\n        if (result) {\n          socket.username = creds.username\n          socket.join('authed')\n          if (options.onAuth) {\n            options.onAuth(socket)\n          }\n        }\n      }).catch(err => {\n        socket.emit('authResponse', false, err)\n      })\n    })\n\n    socket.on('cmd', (cmdId, command) => {\n      if (!socket.username) {\n        socket.emit('cmdResponse', cmdId, `You are not authorized to run commands`)\n        return\n      }\n\n      if (!cmdMan) {\n        cmdMan = createCmdMan(options.cmdManager, socket)\n      }\n\n      cmdMan.runCmd(command, socket.username)\n        .then(output => {\n          socket.emit('cmdResponse', cmdId, null, output)\n        }).catch(err => {\n          socket.emit('cmdResponse', cmdId, err && err.message || err, null)\n        })\n    })\n  })\n\n  _.each(options.handlers, function(handler, event) {\n    io.on(event, handler)\n  })\n\n  return ns\n}\n\nfunction createCmdMan(cmdManager, socket) {\n  let promptId = 0,\n      prompts = {}\n\n  let cmdManOpts = {\n    writeLn: null,\n    write: (val, opts) => {\n      if (!val) return\n\n      socket.emit('console', {\n        method: 'log',\n        args: [ val ]\n      })\n    },\n    error: (val, opts) => {\n      if (!val) return\n\n      socket.emit('console', {\n        method: 'error',\n        args: [ val ]\n      })\n    },\n    prompt: (promptTxt, opts, cb) => {\n      if (typeof opts === 'function') {\n        cb = opts\n        opts = undefined\n      }\n      opts || (opts = {})\n\n      let pid = promptId++\n      socket.emit('prompt', pid, promptTxt, opts)\n\n      prompts[pid] = cb\n    }\n  }\n  cmdManOpts.writeLn = cmdManOpts.write\n\n  socket.on('promptResponse', (promptId, response) => {\n    if (prompts[promptId]) {\n      prompts[promptId](null, response)\n    }\n  })\n\n  return cmdManager.bindI(cmdManOpts)\n}\n\n\n// WEBPACK FOOTER //\n// ./server/setup-socket.js","module.exports = require(\"socket.io\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"socket.io\"\n// module id = 23\n// module chunks = 0","module.exports = require(\"minimist\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"minimist\"\n// module id = 24\n// module chunks = 0","import fs from 'fs'\nimport tty from 'tty'\nimport pty from 'pty.js'\nimport ssh2 from 'ssh2'\nimport termkit from 'terminal-kit'\n\nfunction SSHManager(options) {\n  this.options = options = Object.assign({\n    host: '127.0.0.1',\n    port: 50501,\n    title: 'Node Monkey',\n    prompt: 'Node Monkey:',\n    silent: false\n  }, options)\n\n  this.clients = {}\n  this.clientId = 1\n\n  this.server = ssh2.Server({\n    hostKeys: options.hostKeys.map(file => {\n      return fs.readFileSync(file)\n    })\n  }, this.onClient.bind(this))\n\n  let monkey = this.options.monkey\n  this.server.listen(options.port, options.host, function() {\n    options.silent || monkey.local.log(`SSH listening on ${this.address().port}`)\n  })\n}\n\nObject.assign(SSHManager.prototype, {\n  shutdown() {\n    let clients = this.clients\n    for (let c of clients) {\n      c.write('\\nShutting down')\n      c.close()\n    }\n  },\n\n  onClient(client) {\n    let clientId = clientId++\n    this.clients[clientId] = new SSHClient({\n      client,\n      cmdManager: this.options.cmdManager,\n      userManager: this.options.userManager,\n      title: this.options.title,\n      prompt: this.options.prompt,\n      onClose: () => delete this.clients[clientId]\n    })\n  }\n})\n\n\nfunction SSHClient(options) {\n  this.options = options\n  this.client = options.client\n  this.cmdMan = null\n  this.userManager = options.userManager\n  this.session = null\n  this.stream = null\n  this.pty = null\n  this.term = null\n  this.ptyInfo = null\n\n  this.title = options.title\n  this.promptTxt = `${options.prompt} `\n  this.inputActive = false\n  this.cmdHistory = []\n\n  this.username = null\n\n  this.client.on('authentication', this.onAuth.bind(this))\n  this.client.on('ready', this.onReady.bind(this))\n  this.client.on('end', this.onClose.bind(this))\n}\n\nObject.assign(SSHClient.prototype, {\n  _initCmdMan() {\n    let cmdManOpts = {\n      writeLn: null,\n      write: (val, opts) => {\n        opts || (opts = {})\n        val || (val = '')\n\n        if (opts.bold) {\n          this.term.bold(val)\n        } else {\n          this.term(val)\n        }\n\n        if (opts.newline) {\n          this.term.nextLine()\n        }\n      },\n      error: (val, opts) => {\n        opts || (opts = {})\n\n        // TODO: Apparently by sending this to stdout there is a timing issue and anything sent to\n        //       stdout appears before this value is sent to stderr for some reason.\n        // this.term.red.error(val)\n        this.term.red(val)\n\n        if (opts.newline) {\n          this.term.nextLine()\n        }\n      },\n      prompt: (promptTxt = '', opts, cb) => {\n        if (typeof opts === 'function') {\n          cb = opts\n          opts = undefined\n        }\n        opts || (opts = {})\n\n        let inputOpts = {}\n        if (opts.hideInput) {\n          inputOpts.echo = false\n        }\n\n        this.term(promptTxt)\n        this.term.inputField(inputOpts, cb)\n      }\n    }\n    cmdManOpts.writeLn = (val, opts) => {\n      opts || (opts = {})\n      opts.newline = true\n      cmdManOpts.write(val, opts)\n    }\n    this.cmdMan = this.options.cmdManager.bindI(cmdManOpts)\n  },\n\n  write(msg, opts) {\n    opts || (opts = {})\n    if (this.term) {\n      if (opts.style) {\n        this.term[style](msg)\n      } else {\n        this.term(msg)\n      }\n    }\n  },\n\n  close() {\n    if (this.stream) {\n      this.stream.end()\n    }\n    this.onClose()\n  },\n\n  onAuth(ctx) {\n    if (ctx.method == 'password') {\n      this.userManager.verifyUser(ctx.username, ctx.password).then(result => {\n        if (result) {\n          this.username = ctx.username\n          ctx.accept()\n        } else {\n          ctx.reject()\n        }\n      }).catch(err => {\n        ctx.reject()\n      })\n    } else if (ctx.method == 'publickey') {\n      ctx.reject()\n    } else {\n      ctx.reject()\n    }\n  },\n\n  onReady() {\n    this.client.on('session', (accept, reject) => {\n      this.session = accept()\n\n      this.session\n        .once('pty', (accept, reject, info) => {\n          this.ptyInfo = info\n          accept && accept()\n        })\n        .on('window-change', (accept, reject, info) => {\n          Object.assign(this.ptyInfo, info)\n          this._resize()\n          accept && accept()\n        })\n        .once('shell', (accept, reject) => {\n          this.stream = accept()\n          this._initCmdMan()\n          this._initStream()\n          this._initPty()\n          this._initTerm()\n        })\n    })\n  },\n\n  onClose() {\n    let onClose = this.options.onClose\n    onClose && onClose()\n  },\n\n  onKey(name, matches, data) {\n    if (name === 'CTRL_L') {\n      this.clearScreen()\n    } else if (name === 'CTRL_C') {\n      this.inputActive = false\n      this.inputField.abort()\n      this.term('\\n^^C\\n')\n      this.prompt()\n    } else if (name === 'CTRL_D') {\n      let input = this.inputField.getInput()\n      if (!input.length) {\n        this.term.nextLine()\n        setTimeout(() => {\n          this.close()\n        }, 0)\n      }\n    }\n  },\n\n  _resize() {\n    let term = this.term\n    if (this.term) {\n      this.term.stdout.emit('resize')\n    }\n  },\n\n  _initStream() {\n    let stream = this.stream\n    stream.name = this.title\n    stream.isTTY = true\n    stream.setRawMode = () => {}\n    stream.on('error', error => {\n      console.error('SSH stream error:', error.message)\n    })\n  },\n\n  _initPty() {\n    let newPty = pty.native.open(this.ptyInfo.cols, this.ptyInfo.rows)\n    this.pty = {\n      master_fd: newPty.master,\n      slave_fd: newPty.slave,\n      master: new tty.WriteStream(newPty.master),\n      slave: new tty.ReadStream(newPty.slave)\n    }\n    this.pty.slave.getWindowSize = () => {\n      return [ this.ptyInfo.cols, this.ptyInfo.rows ]\n    }\n    this.stream.stdin.pipe(this.pty.master)\n    this.pty.master.pipe(this.stream.stdout)\n  },\n\n  _initTerm() {\n    let stream = this.stream\n\n    let term = this.term = termkit.createTerminal({\n      stdin: this.pty.slave,\n      stdout: this.pty.slave,\n      stderr: this.pty.slave,\n      generic: this.ptyInfo.term,\n      appName: this.title\n    })\n\n    term.on('key', this.onKey.bind(this))\n    term.windowTitle(this._interpolate(this.title))\n    this.clearScreen()\n  },\n\n  _interpolate(str) {\n    let varRe = /{@(.+?)}/g\n    let vars = {\n      username: this.username\n    }\n\n    let match\n    while(match = varRe.exec(str)) {\n      if (vars[match[1]]) {\n        str = str.replace(match[0], vars[match[1]])\n      }\n    }\n\n    return str\n  },\n\n  clearScreen() {\n    this.term.clear()\n    this.prompt()\n  },\n\n  prompt() {\n    let term = this.term\n    term.windowTitle(this._interpolate(this.title))\n    term.bold(this._interpolate(this.promptTxt))\n\n    if (!this.inputActive) {\n      this.inputActive = true\n      this.inputField = term.inputField({\n        history: this.cmdHistory,\n        autoComplete: Object.keys(this.cmdMan.commands),\n        autoCompleteMenu: true\n      }, (error, input) => {\n        this.inputActive = false\n        term.nextLine()\n\n        if (error) {\n          return term.error(error.message || error)\n        }\n\n        if (!input) {\n          return this.prompt()\n        }\n        input[0] !== ' ' && this.cmdHistory.push(input)\n\n        if (input === 'exit') {\n          // This is delayed briefly so the newline can be echoed to the client, creating cleaner output when exiting\n          setTimeout(this.close.bind(this))\n        } else if (input === 'clear') {\n          this.clearScreen()\n        } else if (input) {\n          this.cmdMan.runCmd(input, this.username)\n            .then(output => {\n              if (typeof output !== 'string') {\n                output = JSON.stringify(output, null, '  ')\n              }\n              this.term(output)\n              this.term.nextLine()\n              this.prompt()\n            })\n            .catch(err => {\n              if (typeof err !== 'string') {\n                err = err.message || JSON.stringify(err, null, '  ')\n              }\n              this.term.red.error(err)\n              this.term.nextLine()\n              this.prompt()\n            })\n        } else {\n          this.prompt()\n        }\n      })\n    }\n  }\n})\n\n\nexport default SSHManager\n\n\n// WEBPACK FOOTER //\n// ./server/ssh-manager.js","module.exports = require(\"tty\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"tty\"\n// module id = 26\n// module chunks = 0","module.exports = require(\"pty.js\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"pty.js\"\n// module id = 27\n// module chunks = 0","module.exports = require(\"ssh2\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"ssh2\"\n// module id = 28\n// module chunks = 0","module.exports = require(\"terminal-kit\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"terminal-kit\"\n// module id = 29\n// module chunks = 0","import fs from 'fs'\nimport scrypt from 'scrypt'\n\nlet useNew = false\ntry {\n  Buffer.from('', 'base64')\n} catch(err) {\n  useNew = true\n}\n\nfunction stringToBuffer(string, base) {\n  if (useNew) {\n    return new Buffer(string, base)\n  } else {\n    return Buffer.from(string, base)\n  }\n}\n\nfunction UserManager(options) {\n  this.userFile = options.userFile\n  this.userFileCache = null\n  this.userFileCreated = false\n\n  if (!options.silent) {\n    this.getUsers().then(users => {\n      let usernames = Object.keys(users)\n      if (!usernames.length) {\n        if (process.env.NODE_ENV === 'production') {\n          console.warn(`No users have been created and you are running in production mode so you will not be able to login.\\n`)\n        } else {\n          console.warn(`It seems there are no users and you are not running in production mode so you will not be able to login. This is probably a bug. Please report it!\\n`)\n        }\n      } else if (usernames.length === 1 && usernames[0] === 'guest') {\n        console.warn(`[WARN] No users detected. You can login with default user 'guest' and password 'guest' when prompted.\\n` +\n          `This user will be disabled when you create a user account.\\n`)\n      }\n    })\n  }\n}\n\nObject.assign(UserManager.prototype, {\n  _readFile() {\n    if (this.userFileCache) {\n      return this.userFileCache\n    }\n\n    try {\n      if (!this.userFile) {\n        let err = new Error(`No user file specified`)\n        err.code = 'ENOENT'\n        throw err\n      }\n\n      this.userFileCache = JSON.parse(fs.readFileSync(this.userFile))\n      this.userFileCreated = true\n      setTimeout(() => { this.userFileCache = null }, 5000)\n\n      return this.userFileCache\n    } catch(err) {\n      if (err.code === 'ENOENT') {\n        return process.env.NODE_ENV === 'production'\n          ? {}\n          : {\n            guest: {\n              password: 'c2NyeXB0AAEAAAABAAAAAZS+vE1+zh4nY6vN21zM3dIzpJVImr8OrK0iJoA+iUPk7WIdo3RhgeATzWENocd7gKNbEKVgq6LbXqrmVjLtnYy5FXyfRCtEtmjUuj19AqcW'\n            }\n          }\n      }\n      throw err\n    }\n  },\n\n  _writeFile(data) {\n    this.userFileCache = null\n    fs.writeFileSync(this.userFile, JSON.stringify(data, null, '  '))\n    this.userFileCreated = true\n  },\n\n  _hashPassword(passwd) {\n    return scrypt.kdfSync(passwd.normalize('NFKC'), { N: 1, r: 1, p: 1 }).toString('base64')\n  },\n\n  _verifyPassword(hash, passwd) {\n    return scrypt.verifyKdfSync(stringToBuffer(hash, 'base64'), passwd.normalize('NFKC'))\n  },\n\n  createUser(username, password) {\n    return new Promise((resolve, reject) => {\n      if (!this.userFile) {\n        return reject(new Error(`No user file found. Did you forget to set the 'dataDir' option?`))\n      }\n\n      let users = this._readFile()\n      if (users[username]) {\n        return reject(new Error(`User '${username}' already exists`))\n      }\n\n      if (!this.userFileCreated) {\n        delete users['guest']\n      }\n\n      users[username] = {\n        password: this._hashPassword(password)\n      }\n      this._writeFile(users)\n      resolve()\n    })\n  },\n\n  deleteUser(username) {\n    return new Promise((resolve, reject) => {\n      if (!this.userFile) {\n        return reject(new Error(`No user file found. Did you forget to set the 'dataDir' option?`))\n      }\n\n      let users = this._readFile()\n      if (!users[username]) {\n        return reject(new Error(`User '${username}' does not exist`))\n      }\n\n      if (!this.userFileCreated) {\n        return reject(new Error(`User file has not been created`))\n      }\n\n      delete users[username]\n      this._writeFile(users)\n      resolve()\n    })\n  },\n\n  setPassword(username, password) {\n    return new Promise((resolve, reject) => {\n      if (!this.userFile) {\n        return reject(new Error(`No user file found. Did you forget to set the 'dataDir' option?`))\n      }\n\n      let users = this._readFile()\n\n      users[username].password = this._hashPassword(password)\n      this._writeFile(users)\n      resolve()\n    })\n  },\n\n  getUsers() {\n    return new Promise((resolve, reject) => {\n      resolve(this._readFile())\n    })\n  },\n\n  getUserData(username) {\n    return new Promise((resolve, reject) => {\n      let users = this._readFile()\n      if (!users[username]) {\n        return reject(new Error(`User '${username}' does not exist`))\n      }\n\n      resolve(users[username])\n    })\n  },\n\n  verifyUser(username, passwd) {\n    return new Promise((resolve, reject) => {\n      this.getUserData(username).then(userData => {\n        resolve(this._verifyPassword(userData.password, passwd))\n      }).catch(reject)\n    })\n  }\n})\n\n\nexport default UserManager\n\n\n\n// WEBPACK FOOTER //\n// ./server/user-manager.js","module.exports = require(\"scrypt\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"scrypt\"\n// module id = 31\n// module chunks = 0"],"sourceRoot":""}